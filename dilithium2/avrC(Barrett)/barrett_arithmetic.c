#include "NTT_params.h"
#include "ntt.h"
#include "params.h"
#include "reduce.h"
#include <stdint.h>

__flash
int32_t streamlined_CT_table[N << 1] = {
-3572223, -1830765815, 3765607, 1929875198, 3761513, 1927777021, -3201494, -1640767044, -2883726, -1477910808, -3145678, -1612161320, -3201430, -1640734244, -601683, -308362795, 3542485, 1815525077, 2682288, 1374673747, 2129892, 1091570561, 3764867, 1929495947, -1005239, -515185417, 557458, 285697463, -1221177, -625853735, -3370349, -1727305304, -4063053, -2082316400, 2663378, 1364982364, -1674615, -858240904, -3524442, -1806278032, -434125, -222489248, 676590, 346752664, -1335936, -684667771, -3227876, -1654287830, 1714295, 878576921, 2453983, 1257667337, 1460718, 748618600, -642628, -329347125, -3585098, -1837364258, 2815639, 1443016191, 2283733, 1170414139, 3602218, 1846138265, 3182878, 1631226336, 2740543, 1404529459, -3586446, -1838055109, -3110818, -1594295555, 2101410, 1076973524, 3704823, 1898723372, 1159875, 594436433, 394148, 202001019, 928749, 475984260, 1095468, 561427818, -3506380, -1797021249, 2071829, 1061813248, -4018989, -2059733581, 3241972, 1661512036, 2156050, 1104976547, 3415069, 1750224323, 1759347, 901666090, -817536, -418987550, -3574466, -1831915353, 3756790, 1925356481, -1935799, -992097815, -1716988, -879957084, -3950053, -2024403852, -2897314, -1484874664, 3192354, 1636082790, 556856, 285388938, 3870317, 1983539117, 2917338, 1495136972, 1853806, 950076368, 3345963, 1714807468, 1858416, 952438995, 3073009, 1574918427, 1277625, 654783359, -2635473, -1350681039, 3852015, 1974159335, 4183372, 2143979939, -3222807, -1651689966, -3121440, -1599739335, -274060, -140455867, 2508980, 1285853323, 2028118, 1039411342, 1937570, 993005454, -3815725, -1955560694, 2811291, 1440787840, -2983781, -1529189038, -1109516, -568627424, 4158088, 2131021878, 1528066, 783134478, 482649, 247357819, 1148858, 588790216, -2962264, -1518161567, -565603, -289871779, 169688, 86965173, 2462444, 1262003603, -3334383, -1708872713, -4166425, -2135294594, -3488383, -1787797779, 1987814, 1018755525, -3197248, -1638590967, 1736313, 889861155, 235407, 120646188, -3250154, -1665705315, 3258457, 1669960606, -2579253, -1321868265, 1787943, 916321552, -2391089, -1225434135, -2254727, -1155548552, 3482206, 1784632064, -4182915, -2143745726, -1300016, -666258756, -2362063, -1210558298, -1317678, -675310538, 2461387, 1261461890, 3035980, 1555941048, 621164, 318346816, 3901472, 1999506068, -1226661, -628664287, 2925816, 1499481951, 3374250, 1729304568, 1356448, 695180180, -2775755, -1422575624, 2683270, 1375177022, -2778788, -1424130038, -3467665, -1777179795, 2312838, 1185330464, -653275, -334803717, -459163, -235321234, 348812, 178766299, -327848, -168022240, 1011223, 518252220, -2354215, -1206536194, -3818627, -1957047970, -1922253, -985155484, -2236726, -1146323031, 1744507, 894060583, 1753, 898413, -1935420, -991903578, -2659525, -1363007700, -1455890, -746144248, 2660408, 1363460238, -1780227, -912367099, -59148, -30313375, 2772600, 1420958686, 1182243, 605900043, 87208, 44694137, 636927, 326425360, -3965306, -2032221021, -3956745, -2027833504, -2296397, -1176904444, -3284915, -1683520342, -3716946, -1904936414, -27812, -14253662, 822541, 421552614, 1009365, 517299994, -2454145, -1257750362, -1979497, -1014493059, 1596822, 818371958, -3956944, -2027935492, -3759465, -1926727420, -1685153, -863641633, -3410568, -1747917558, 2678278, 1372618620, -3768948, -1931587462, -3551006, -1819892093, 635956, 325927722, -250446, -128353682, -2455377, -1258381762, -4146264, -2124962073, -1772588, -908452108, 2192938, 1123881663, -1727088, -885133339, 2387513, 1223601433, -3611750, -1851023419, -268456, -137583815, -3180456, -1629985060, 3747250, 1920467227, 2296099, 1176751719, 1239911, 635454918, -3838479, -1967222129, 3195676, 1637785316, 2642980, 1354528380, 1254190, 642772911, -12417, -6363718, 2998219, 1536588520, 141835, 72690498, -89301, -45766801, 2513018, 1287922800, -1354892, -694382729, 613238, 314284737, -1310261, -671509323, -2218467, -1136965286, -458740, -235104446, -1921994, -985022747, 4040196, 2070602178, -3472069, -1779436847, 2039144, 1045062172, -1879878, -963438279, -818761, -419615363, -2178965, -1116720494, -1623354, -831969619, 2105286, 1078959975, -2374402, -1216882040, -2033807, -1042326957, 586241, 300448763, -1179613, -604552167, 527981, 270590488, -2743411, -1405999311, -1476985, -756955444, 1994046, 1021949428, 2491325, 1276805128, -1393159, -713994583, 507927, 260312805, -1187885, -608791570, -724804, -371462360, -1834526, -940195359, -3033742, -1554794072, -338420, -173440395, 2647994, 1357098057, 3009748, 1542497137, -2612853, -1339088280, 4148469, 2126092136, 749577, 384158533, -4022750, -2061661095, 3980599, 2040058690, 2569011, 1316619236, -1615530, -827959816, 1723229, 883155599, 1665318, 853476187, 2028038, 1039370342, 1163598, 596344473, -3369273, -1726753853, 3994671, 2047270596, -11879, -6087993, -1370517, -702390549, 3020393, 1547952704, 3363542, 1723816713, 214880, 110126092, 545376, 279505433, -770441, -394851342, 3105558, 1591599803, -1103344, -565464272, 508145, 260424530, -553718, -283780712, 860144, 440824168, 3430436, 1758099917, 140244, 71875110, -1514152, -776003547, -2185084, -1119856484, 3123762, 1600929361, 2358373, 1208667171, -2193087, -1123958025, -3014420, -1544891539, -1716814, -879867909, 2926054, 1499603926, -392707, -201262505, -303005, -155290192, 3531229, 1809756372, -3974485, -2036925262, -3773731, -1934038751, 1900052, 973777462, -781875, -400711272, 1054478, 540420426, -731434, -374860238
};

__flash
int32_t streamlined_CT_inv_table[N << 1] = {
1, 513, 1, 513, 3572223, 1830765815, 1, 513, -3761513, -1927777021, 3572223, 1830765815, -3765607, -1929875198, 1, 513, 3201430, 1640734244, -3761513, -1927777021, 2883726, 1477910808, 3572223, 1830765815, 3145678, 1612161320, -3765607, -1929875198, 3201494, 1640767044, 1, 513, 1221177, 625853735, 3201430, 1640734244, -2129892, -1091570561, -3761513, -1927777021, 1005239, 515185417, 2883726, 1477910808, -3542485, -1815525077, 3572223, 1830765815, -557458, -285697463, 3145678, 1612161320, -2682288, -1374673747, -3765607, -1929875198, -3764867, -1929495947, 3201494, 1640767044, 601683, 308362795, 1, 513, -2283733, -1170414139, 1221177, 625853735, 1335936, 684667771, 3201430, 1640734244, -1460718, -748618600, -2129892, -1091570561, 1674615, 858240904, -3761513, -1927777021, 3585098, 1837364258, 1005239, 515185417, 434125, 222489248, 2883726, 1477910808, -1714295, -878576921, -3542485, -1815525077, 4063053, 2082316400, 3572223, 1830765815, -2815639, -1443016191, -557458, -285697463, -676590, -346752664, 3145678, 1612161320, -2453983, -1257667337, -2682288, -1374673747, -2663378, -1364982364, -3765607, -1929875198, 642628, 329347125, -3764867, -1929495947, 3524442, 1806278032, 3201494, 1640767044, 3227876, 1654287830, 601683, 308362795, 3370349, 1727305304, 1, 513, -1858416, -952438995, -2283733, -1170414139, -2156050, -1104976547, 1221177, 625853735, 3950053, 2024403852, 1335936, 684667771, -1159875, -594436433, 3201430, 1640734244, -3870317, -1983539117, -1460718, -748618600, 3506380, 1797021249, -2129892, -1091570561, 3574466, 1831915353, 1674615, 858240904, 3586446, 1838055109, -3761513, -1927777021, -1853806, -950076368, 3585098, 1837364258, 4018989, 2059733581, 1005239, 515185417, 1935799, 992097815, 434125, 222489248, -2101410, -1076973524, 2883726, 1477910808, -3192354, -1636082790, -1714295, -878576921, -928749, -475984260, -3542485, -1815525077, -1759347, -901666090, 4063053, 2082316400, -3182878, -1631226336, 3572223, 1830765815, -3345963, -1714807468, -2815639, -1443016191, -3241972, -1661512036, -557458, -285697463, 1716988, 879957084, -676590, -346752664, -3704823, -1898723372, 3145678, 1612161320, -556856, -285388938, -2453983, -1257667337, -1095468, -561427818, -2682288, -1374673747, 817536, 418987550, -2663378, -1364982364, -2740543, -1404529459, -3765607, -1929875198, -2917338, -1495136972, 642628, 329347125, -2071829, -1061813248, -3764867, -1929495947, -3756790, -1925356481, 3524442, 1806278032, 3110818, 1594295555, 3201494, 1640767044, 2897314, 1484874664, 3227876, 1654287830, -394148, -202001019, 601683, 308362795, -3415069, -1750224323, 3370349, 1727305304, -3602218, -1846138265, 1, 513, -1744507, -894060583, -1858416, -952438995, -3258457, -1669960606, -2283733, -1170414139, -3374250, -1729304568, -2156050, -1104976547, -4158088, -2131021878, 1221177, 625853735, 459163, 235321234, 3950053, 2024403852, 3334383, 1708872713, 1335936, 684667771, 2362063, 1210558298, -1159875, -594436433, 274060, 140455867, 3201430, 1640734244, 2354215, 1206536194, -3870317, -1983539117, 3197248, 1638590967, -1460718, -748618600, -621164, -318346816, 3506380, 1797021249, 3815725, 1955560694, -2129892, -1091570561, 2778788, 1424130038, 3574466, 1831915353, 2962264, 1518161567, 1674615, 858240904, 2254727, 1155548552, 3586446, 1838055109, -3852015, -1974159335, -3761513, -1927777021, 1922253, 985155484, -1853806, -950076368, -235407, -120646188, 3585098, 1837364258, 1226661, 628664287, 4018989, 2059733581, 2983781, 1529189038, 1005239, 515185417, -2312838, -1185330464, 1935799, 992097815, -169688, -86965173, 434125, 222489248, 4182915, 2143745726, -2101410, -1076973524, 3222807, 1651689966, 2883726, 1477910808, 327848, 168022240, -3192354, -1636082790, 3488383, 1787797779, -1714295, -878576921, -2461387, -1261461890, -928749, -475984260, -2028118, -1039411342, -3542485, -1815525077, 2775755, 1422575624, -1759347, -901666090, -482649, -247357819, 4063053, 2082316400, -1787943, -916321552, -3182878, -1631226336, -1277625, -654783359, 3572223, 1830765815, 2236726, 1146323031, -3345963, -1714807468, 3250154, 1665705315, -2815639, -1443016191, -2925816, -1499481951, -3241972, -1661512036, 1109516, 568627424, -557458, -285697463, 653275, 334803717, 1716988, 879957084, -2462444, -1262003603, -676590, -346752664, 1300016, 666258756, -3704823, -1898723372, 3121440, 1599739335, 3145678, 1612161320, -1011223, -518252220, -556856, -285388938, -1987814, -1018755525, -2453983, -1257667337, -3035980, -1555941048, -1095468, -561427818, -1937570, -993005454, -2682288, -1374673747, -2683270, -1375177022, 817536, 418987550, -1148858, -588790216, -2663378, -1364982364, 2391089, 1225434135, -2740543, -1404529459, 2635473, 1350681039, -3765607, -1929875198, 3818627, 1957047970, -2917338, -1495136972, -1736313, -889861155, 642628, 329347125, -3901472, -1999506068, -2071829, -1061813248, -2811291, -1440787840, -3764867, -1929495947, 3467665, 1777179795, -3756790, -1925356481, 565603, 289871779, 3524442, 1806278032, -3482206, -1784632064, 3110818, 1594295555, -4183372, -2143979939, 3201494, 1640767044, -348812, -178766299, 2897314, 1484874664, 4166425, 2135294594, 3227876, 1654287830, 1317678, 675310538, -394148, -202001019, -2508980, -1285853323, 601683, 308362795, -1356448, -695180180, -3415069, -1750224323, -1528066, -783134478, 3370349, 1727305304, 2579253, 1321868265, -3602218, -1846138265, -3073009, -1574918427
};

__flash
int32_t last_twist_table[N << 1] = {
-32736, -16777214, -1372055, -703178774, 4019714, 2060105144, 3511264, 1799524301, 3659173, 1875327727, -1852791, -949556180, 2900776, 1486648940, -2642025, -1354038942, -1416569, -725992218, 2886683, 1479426272, -2828477, -1449595672, 4157521, 2130731290, 580826, 297673573, -974914, -499643842, -3944563, -2021590224, -2669833, -1368290554, -1861182, -953856571, -96674, -49545466, 3308130, 1695418040, 958010, 490980535, 899302, 460892660, 1128738, 578478708, 569537, 291887956, -3422595, -1754081401, -4184990, -2144809165, 3898594, 1998031092, 1613291, 826812327, 2893192, 1482762137, -2001427, -1025732193, -3753924, -1923887655, 3798447, 1946705712, 3917490, 2007715300, 3482522, 1784794014, -1131019, -579647721, -1267508, -649598392, 1944987, 996806669, 3553106, 1820968344, 3037717, 1556831261, -2082615, -1067341078, -3782654, -1938611792, -594954, -304914179, 329523, 168880678, 3533062, 1810695786, -476046, -243973779, 1715969, 879434846, -223710, -114651471, -1458215, -747335811, -3978303, -2038881989, -924928, -474025996, 2136407, 1094909501, 3022567, 1549066880, 3983976, 2041789404, 2043595, 1047343311, -1452141, -744222883, -2869197, -1470464689, 4167059, 2135619519, -3889043, -1993136200, 3425482, 1755560990, 3969864, 2034556998, -3659686, -1875590640, 3745914, 1919782527, 3707113, 1899896998, -571559, -292924232, -583561, -299075262, 3422587, 1754077301, -1666482, -854072738, 1677045, 859486280, -2284177, -1170641689, 3593719, 1841782524, 188494, 96603256, -3700088, -1896296682, 1699788, 871142077, -2408460, -1234336780, 1165096, 597112198, 2983768, 1529182376, 1168172, 598688650, -1457421, -746928886, -1468480, -752596628, -3294681, -1688525421, -2511702, -1287248349, 2393655, 1226749211, -2546702, -1305185864, -4002827, -2051450549, 3860453, 1978483813, 2397290, 1228612150, -376301, -192854423, -1310103, -671428348, -3476254, -1781581661, 1671232, 856507115, 3141817, 1610182556, 4108340, 2105526007, -3324964, -1704045472, -3085393, -1581265232, 1150368, 589564092, -740339, -379424054, -91254, -46767714, 3743169, 1918375713, -1159554, -594271921, 2882049, 1477051345, 1775252, 909817409, 1100554, 564034396, 1659501, 850494972, -4143846, -2123722847, 3941643, 2020093723, 3888888, 1993056763, 528086, 270644301, -1744623, -894120034, 1136791, 582605874, -625612, -320626418, 2021843, 1036195402, 2807374, 1438780375, -2881109, -1476569594, -1421486, -728512183, 1624598, 832607170, 1745851, 894749384, 359542, 184265429, 3757768, 1925857707, 394154, 202004094, 2911619, 1492205983, 422355, 216457118, -2504801, -1283711584, -3371762, -1728029467, 1269720, 650732043, -1433460, -734648863, 969647, 496944502, -1906912, -977293215, -2329247, -1193740083, -1956600, -1002758337, 46690, 23928645, 454185, 232770007, -1759007, -901491840, -2386530, -1223097645, 1394578, 714721821, 2548863, 1306293377, 732888, 375605413, -2552430, -1308121466, -3448279, -1767244462, -1440932, -738478266, -273317, -140075079, 1500957, 769241104, -405496, -207816873, -2223217, -1139399663, -388498, -199105391, 2533504, 1298421883, -3603138, -1846609766, -862566, -442065444, 1213784, 622064819, -1729890, -886569365, 137651, 70546196, 291696, 149494325, -664339, -340474022, 1586785, 813227991, -591891, -303344391, 3140526, 1609520918, -1566250, -802703795, 2881817, 1476932445, -309096, -158411832, 3566162, 1827659550, -1035359, -530621930, -392601, -201208180, 1649088, 845158305, -2767035, -1418106621, 748978, 383851545, 115162, 59020574, 1831041, 938409295, 2821607, 1446074794, -858901, -440187130, 185954, 95301505, -1089874, -558560891, -493025, -252675523, 2476077, 1268990521, 3366965, 1725571002, 1436105, 736004427, -2203044, -1129060992, -3084753, -1580937232, -35224, -18052315, -2629358, -1347547099, 3297124, 1689777460, -4004274, -2052192137, 1407997, 721599065, -4187015, -2145846978, -2301864, -1179706284, -2296008, -1176705082, -1411591, -723440991, -1516260, -777083898, 3508106, 1797905825, -1594724, -817296732, 1366346, 700252909, 2051663, 1051478165, -56197, -28800987, 1548887, 793805250, 1941813, 995179993, 3357099, 1720514673, 647298, 331740502, 4106917, 2104796719, 3396579, 1740748190, -1255364, -643374587, 1237463, 634200317, 3954274, 2026567116, -968209, -496207527, -2223538, -1139564176, -527136, -270157425, 1032312, 529060341, 904125, 463364449, 679363, 348173828, 750944, 384859121, -3317318, -1700126893, -279168, -143073719, -4106707, -2104689094, -642945, -329509587, 3647242, 1869213085, 3802669, 1948869489, -342035, -175293084, -3819906, -1957703458, -3238655, -1659812072, -3429548, -1757644816, -2932473, -1502893666, -1388051, -711376731, 3063582, 1570087085, 1856626, 951521619, 3089336, 1583286021, 30446, 15603588, 2471595, 1266693494, 1822824, 934198079, 1387418, 711052318, 3242048, 1661550986, -3798739, -1946855362, 394624, 202244969, 3088502, 1582858596, 1784931, 914777901, -802125, -411089405, 3116503, 1597209120, 929217, 476224110, 708061, 362881565, -1500709, -769114004, -2568046, -1316124673, -3013252, -1544292938, -3955287, -2027086279, -2497737, -1280091281, 1141142, 584835763, -2714738, -1391304386, -4050729, -2076000345, -3147955, -1613328284, -1746720, -895194747, 936004, 479702450, 3743755, 1918676038, 59503, 30495313, 3011821, 1543559550, -3555059, -1821969258, 1522988, 780532001, -1724933, -884028900, -2864572, -1468094375, 1360841, 697431594, -1892347, -969828647, -503044, -257810265, -1276711, -654314933
};

int32_t freeze_32(int32_t a)
{
    volatile int32_t t = (a + (1ULL << 22)) >> 23;
    a -= t * Q;
    
    //if(a>= Q/2) a-=Q;
    a -= (0 - (1 ^  (a^((a^(a-Q/2))&(Q/2^(a-Q/2))))>>31)) & Q;
    //if(a<= -Q/2) a+=Q;
    a += (0 - (1 ^ (-Q/2^((-Q/2^(-Q/2-a))&(a^(-Q/2-a))))>>31)) & Q;

    return a;
}

// we assume -Q / 2 < a < Q / 2
int32_t gethi(int32_t a)
{

    int32_t lo, hi;

    int32_t bp_lo, bp_hi;
    int32_t a_lo, a_hi;

    // below we compute lo = a R mod^+- Q
    lo = a * RmodQ;

    bp_lo = (int32_t)(uint16_t)RmodQhi;
    bp_hi = (int32_t)(int16_t)(RmodQhi >> 16);

    a_lo = (int32_t)(uint16_t)a;
    a_hi = (int32_t)(int16_t)(a >> 16);

    hi = a_hi * bp_hi;
    hi += ((a_lo * bp_hi) >> 16);
    hi += ((a_hi * bp_lo) >> 16);

    lo -= hi * Q;

    lo = freeze_32(lo);

    // return (a R mod^+- Q) * Qprime mod^+- R
    // we reduce mod^+- R by typing
    return lo * Qprime;
}

int32_t Barrett_mul_approx(int32_t a, int32_t b, int32_t bp, int32_t q) {

    int32_t lo, hi;

    int32_t bp_lo, bp_hi;
    int32_t a_lo, a_hi;

    lo = a * b;

    bp_lo = (int32_t)(uint16_t)bp;
    bp_hi = (int32_t)(int16_t)(bp >> 16);

    a_lo = (int32_t)(uint16_t)a;
    a_hi = (int32_t)(int16_t)(a >> 16);

    hi = a_hi * bp_hi;
    hi += ((a_lo * bp_hi) >> 16);
    hi += ((a_hi * bp_lo) >> 16);

    return lo - hi * q;

}

void barrett_ntt(int32_t a[N])
{
    unsigned int len, start, j, k;
    int32_t zeta, zetap, t;

    k = 0;
    for (len = 128; len > 0; len >>= 1) {
        for (start = 0; start < N; start = j + len)
        {
            zeta = streamlined_CT_table[k++];
            zetap = streamlined_CT_table[k++];
            for (j = start; j < start + len; ++j) {
                //! if we want stream : t = Barrett_mul_approx(a[j + len], zeta, gethi(zeta), Q);
                t = Barrett_mul_approx(a[j + len], zeta, zetap, Q);
                a[j + len] = a[j] - t;
                a[j] = a[j] + t;
            }
        }
    }
}

void barrett_invntt(int32_t a[N])
{
    unsigned int len, i, j, k;
    int32_t t, zeta, zetap;

    k = 0;
    for (len = 1; len < N; len <<= 1)
    {
        for (i = 0; i < len; i++)
        {
            zeta = streamlined_CT_inv_table[k++];
            zetap = streamlined_CT_inv_table[k++];
            for (j = 0; j < N / (len << 1); j++)
            {
                if (zeta == 1) t = a[j * (len << 1) + i + len]; //! do light Butterfly
                else t = Barrett_mul_approx(a[j * (len << 1) + i + len], zeta, zetap, Q); //! do Origin Butterfly
                //! if we want stream : t = Barrett_mul_approx(a[j * (len << 1) + i + len], zeta, gethi(zeta), Q);                
                a[j * (len << 1) + i + len] = a[j * (len << 1) + i] - t;
                a[j * (len << 1) + i] = a[j * (len << 1) + i] + t;
            }
        }
    }
    
    point_mul_pre(a, a);
}

void point_mul_on_the_fly(int32_t res[N], int32_t src1[N], int32_t src2[N])
{
    for (int cnt_i = 0; cnt_i < N; cnt_i++)
    {
        res[cnt_i] = Barrett_mul_approx(src1[cnt_i], src2[cnt_i], gethi(src2[cnt_i]), Q);
        res[cnt_i] = freeze_32(res[cnt_i]);
    }
}

void point_mul_pre(int32_t res[N], int32_t src1[N])
{
    for (int cnt_i = 0; cnt_i < N; cnt_i++)
    {
        res[cnt_i] = Barrett_mul_approx(src1[cnt_i], last_twist_table[2 * cnt_i + 0], last_twist_table[2 * cnt_i + 1], Q);
        res[cnt_i] = freeze_32(res[cnt_i]);
    }
}